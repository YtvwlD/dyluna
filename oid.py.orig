#!/usr/bin/env python
import werkzeug
import werkzeug.wrappers
import werkzeug.wsgi
import werkzeug.urls
#import urllib
#from bs4 import BeautifulSoup

import openid
import openid.consumer
import openid.consumer.consumer
import openid.sreg

import get_html


import SQLcon



def run(environ, start_response):
	request = werkzeug.wrappers.Request(environ)
	response = werkzeug.wrappers.Response("This didn't succeed.", 500)

	sid = request.args.get("sid")
	consumer = openid.consumer.consumer.Consumer({"sid": sid}, None)
	#url = request.args.get("openid.return_to") #TODO: compute the URL in a better way -> Should be done now.
	href =  werkzeug.urls.Href(werkzeug.wsgi.get_current_url(environ))
	url = href("../oid.py", {"sid": sid})
#	try:
	info = consumer.complete(request.args, url) # <-- It crashes here. (When using an OpenID from Yahoo!)
	#print info.status
#	except Exception as e:
#	info = openid.consumer.consumer.Response()
#	info.status = e
	if info.status == openid.consumer.consumer.SUCCESS:
		#print "SUCCESS" #TODO: do something here
		display_identifier =  info.getDisplayIdentifier()
		sregresp = openid.sreg.SRegResponse.fromSuccessResponse(info)
		realoid = display_identifier
		if info.endpoint.canonicalID:
			realoid = info.endpoint.canonicalID
		#print "The real OID is " + realoid + "."
		#print "We have gotten the following data: "
		#print sregresp.data

		try:
			nickname = sregresp.data["nickname"]
		except:
			nickname = ""

		try:
			email = sregresp.data["email"]
		except:
			email = ""

		#TODO:
		con = SQLcon.con()
		cur = con.cursor()
		cur.execute("SELECT * FROM users WHERE openid=%s", (realoid))
		result = cur.fetchall()
<<<<<<< HEAD
		if result.__len__() == 0:
			cur.execute("INSERT INTO users (username, openid, email, first_login) VALUES (%s, %s, %s, true)", (nickname, realoid, email))
=======
		if len(result) == 0:
			cur.execute("INSERT INTO users (username, openid, email, first_login) VALUES ('"+nickname+"', '"+realoid+"', '"+email+"', true)")
>>>>>>> 6c18fab... Use len(something) instead of something.__len__().


		#log in

		cur.execute("SELECT uid FROM users WHERE openid=%s", (realoid))
		result = cur.fetchall()
		uid = result[0][0]
		#print result
		cur.execute("UPDATE sessions SET uid=%s WHERE sid=%s", (str(uid), sid))
		cur.execute("UPDATE sessions SET oid=%s WHERE sid=%s", (realoid, sid))
		con.close()


		response = werkzeug.wrappers.Response(get_html.get_html("inc/html/oid_success"), 200, mimetype="text/html")


	#elif info.status == openid.consumer.consumer.CANCEL:
	#	pass
		#print "CANCEL" #TODO: be angry

	#elif info.status ==  openid.consumer.consumer.SETUP_NEEDED:
	#	pass
		#print "setup needed for: "  + info.setup_url #TODO: Tell the users that they have got something to do.

	else:
		#print "something went wrong." #TODO: something went wrong.
		response = werkzeug.wrappers.Response(get_html.get_html("inc/html/oid_failure"), 500, mimetype="text/html")


	#TODO
	return response(environ, start_response)

if __name__ == "__main__":
	import CGI
	CGI.app = run
	CGI.run()
